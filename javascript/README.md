# Javascript Part

This part includes one tool called `js-deserial-breaker`, which helps generate the payload used for deserialization attack, and two defenses (jsflow and js-sandbox), which help to defend this deserialization attack.

There's also one module called AP_Cloud, which is one example victim application to test the feasibility of our attacking tool.

Before testing them, please make sure your node.js environment is ready. We test our work under node.js v16.15.0. But an older version may also work. The jsflow version is 1.2.

## Instructions

### js-deserial-breaker

To use this tool, please `cd` to the `js-deserial-breaker` folder and run the command: 

```
node main.js [module name] [overwrite method] [insert code snippet file]
```

For example:

```
node main.js node-serialize toValue remoteCode.js
```

Then it will create the malicious payload of `node-serialize` and the magic method `toValue` will trigger the malicious code in `remoteCode.js`

To test it under AP_Cloud, please rename the generated payload (under `output` folder) to replace the logger_data.json in the `AP_Cloud` folder. Then go to the `AP_Cloud` folder and run 

```
node index.js
```

To see if the Remote Code Execution is done. (I have already replaced it, so you can directly launch the AP_Cloud to see the result)

### js-sandbox

To test this tool, please first generate the malicious payload using the JsDBreaker, and `mv` the generated file to the `inputPayload` folder under `js-sandbox`. 

Then `cd` to the `js-sandbox` folder and run the command: 

```
node index.js [module name] [payload file] [custom test script]
```

For example:

```
node index.js node-serialize inputPayload/serialize-javascript_payload.json runscript/customScript.js
```

Then it test the payload with the custom test script. If there's any error detected, it will alarm and prompt user to check the error report under `logs` folder.

### jsflow

To test this tool, please first generate the malicious payload using the JsDBreaker, and `mv` the generated file to the `inputPayload` folder under `jsflow-1.2`. 

Then `cd` to the `jsflow-1.2` folder and run the command: 

```
node ScriptGen.js [module name] [payload file] [custom test script]
```

For example:

```
node ScriptGen.js node-serialize inputPayload/serialize-javascript_payload.json runscript/customScript.js
```

Then run the following command:

```
./jsflow test/serialize-javascript_test.js
```

to run the generated test script in JSFlow.

Then JSFlow tests the payload with the custom test script. If there's any error detected, it will alarm the `security violation`.

## File Tree
```
├── AP_Cloud
│   ├── index.js	: System entrance
│   └── logger_data.json	: The serialized data which is vulnerable
├── js-deserial-breaker
│   ├── lib	: The folder includes all the local modules
│   ├── main.js	: The program entrance
│   ├── output	: The folder contains the output payloads
│   ├── remoteCode.js	: The example malicious code snippet
│   └── tools.js	: The tool that could be used to encode data
├── jsflow-1.2
│   ├── inputPayload	： The folder contains input payloads
│   ├── jsflow	: The jsflow program entrance
│   ├── Makefile
│   ├── out
│   ├── policies
│   ├── README.md
│   ├── runscript	： The folder contains all the local parsing modules
│   ├── ScriptGen.js	: The entrance of program to generate test jsflow scripts
│   ├── src
│   ├── test	: The generated test scripts
│   └── tsconfig.json
└──  js-sandbox
     ├── index.js	: The program entrance
     ├── inputPayload	: The folder contains input payloads
     ├── logs	: The error logs generated by the sandbox
     └── runscript	: The local modules to generate test scripts of sandbox
```
